<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" /> 
  <title>Accounts in Backbone.js</title>

  <!-- ========= -->
  <!--    CSS    -->
  <!-- ========= -->
  <link href="css/bootstrap.css" rel="stylesheet">
  <style type="text/css">
    #content ul {
      list-style-type: none; /* Hides bullet points from account list */
    }
    .nav-bar > li > a:hover {
      background-color: yellow;
    }
  </style>  
  <link href="css/bootstrap-responsive.css" rel="stylesheet">
</head>
<body>

  <!-- ========= -->
  <!-- HTML CODE -->
  <!-- ========= -->
  <div class="container">
    <div class="row-fluid">
        <div id="content" class="span12>">
          <h2>Loading accounts</h2>
        </div>
    </div>
  </div>

  <!-- ========= -->
  <!-- Templates -->
  <!-- ========= -->
  <script type="text/template" id="accounts-template">
    <div id="header">
      <h1>Accounts</h1>
      <p>Type a new account name and hit enter to create it: <input id="new-account" placeholder="New account name" autofocus="true" /></p>
      <p>Click an account name to edit that account.</p>
    </div>
    <div id="main">
      <ul class="nav nav-list" id="account-list">
      </ul>
    </div>
  </script>

  <script type="text/template" id="account-template">
    <div class="account-view">
      <% if (typeof Id !== 'undefined') { %>
        <a href="#/<%= Id %>"><%- Name %></a> 
      <% } else { %>
        <%- Name %>
      <% } %>
    </div>
  </script>

  <script type="text/template" id="account-detail-template">
    <div class="account-edit-view">
      <div class="row-fluid">
      <form class="form-horizontal span12">
        <fieldset>
          <legend>Account</legend>
          <br/>
          <div class="row">
            <div class="span8">
              <div class="control-group">
                <label for="accountId" class="control-label">Id:</label>
                <div class="controls">
                  <input id="accountId" name="Id" type="text" value="<%- Id %>" disabled="true" />
                </div>
              </div>
              <div class="control-group">
                <label for="Name" class="control-label">Name:</label>
                <div class="controls">
                  <input class="edit" id="Name" name="Name" value="<%- Name %>" />
                </div>
              </div>
              <div class="control-group">
                <label for="Industry" class="control-label">Industry:</label>
                <div class="controls">
                  <input class="edit" id="Industry" name="Industry" value="<%- Industry %>">
                </div>
              </div>
            </div>
          </div>
        </fieldset>
        <div class="form-actions">
            <a href="#" class="btn btn-primary save">Save</a>
            <a href="#" class="btn destroy">Delete</a>
            <br/><br/><a href="#">back to list</a>
        </div>
      </form>
      </div>
    </div>
  </script>

  <!-- ========= -->
  <!-- Libraries -->
  <!-- ========= -->
  <script src="lib/jquery.min.js" type="text/javascript"></script>
  <script src="lib/underscore-min.js" type="text/javascript"></script>
  <script src="lib/backbone.js" type="text/javascript"></script>
  <script src="lib/forcetk.js" type="text/javascript"></script>
  <script src="lib/backbone.force.js" type="text/javascript"></script>
  <script src="lib/bootstrap.min.js" type="text/javascript"></script>

  <!-- =============== -->
  <!-- Javascript code -->
  <!-- =============== -->
  <script type="text/javascript">

    // OAuth Configuration
    var loginUrl    = 'https://login.salesforce.com/';
    var clientId    = 'YOUR_REMOTE_ACCESS_APP_CLIENT_ID';
    var redirectUri = 'https://YOUR_WEB_APP_HOST_AND_DIRECTORY/oauthcallback.html';
    var proxyUrl    = 'https://YOUR_WEB_APP_HOST_AND_DIRECTORY/proxy.php?mode=native';

    var client = new forcetk.Client(clientId, loginUrl, proxyUrl);

    // TBD - abstract out OAuth boilerplate
    var loginWindow = null;

    function getAuthorizeUrl(loginUrl, clientId, redirectUri){
        return loginUrl+'services/oauth2/authorize?display=popup'
            +'&response_type=token&client_id='+escape(clientId)
            +'&redirect_uri='+escape(redirectUri);
    }

    function openWindow(url, name, height, width) {
      centeredY = window.screenY + (((window.outerHeight/2) - (height/2)));
      centeredX = window.screenX + (((window.outerWidth/2) - (width/2)));
      loginWindow = window.open(url, name, 
        'height=' + height +
        ',width=' + width +
        ',toolbar=0' +
        ',scrollbars=0' +
        ',status=0' +
        ',resizable=0' +
        ',location=0' +
        ',menuBar=0' +
        ',left=' + centeredX +
        ',top=' + centeredY);
      loginWindow.focus();
    }

    function sessionCallback(oauthResponse) {
      if (typeof oauthResponse === 'undefined'
          || typeof oauthResponse['access_token'] === 'undefined') {
          errorCallback({
              status: 0, 
              statusText: 'Unauthorized', 
              responseText: 'No OAuth response'
          });
      } else {
          client.setSessionToken(oauthResponse.access_token, null,
              oauthResponse.instance_url);

          loginWindow.close();

          // Let the caller close the popup window
          setTimeout(myapp, 10);
      }
    }

    function errorCallback(jqXHR){
      alert(jqXHR.statusText);
    }

    $(document).ready(function() {
      openWindow(getAuthorizeUrl(loginUrl, clientId, redirectUri), 'Login', 524, 675);
    });

    function myapp() {
      Backbone.Force.initialize(client);

      var app = {}; // create namespace for our app

      //--------------
      // Models
      //--------------
      app.Account = Backbone.Force.Model.extend({
        type:'Account',
        fields:['Id', 'Name', 'Industry']
      });

      //--------------
      // Collections
      //--------------
      app.AccountsCollection = Backbone.Force.Collection.extend({
        model: app.Account,
        query: "WHERE IsDeleted = false"
      }),

      //--------------
      // Views
      //--------------

      // renders individual Account list item (li)
      app.AccountView = Backbone.View.extend({
        tagName: 'li',
        template: _.template($('#account-template').html()),
        render: function(){
          this.$el.html(this.template(this.model.toJSON()));
          return this; // enable chained calls
        },
        initialize: function(){
        }
      });

      // renders individual Account for editing
      app.AccountDetailView = Backbone.View.extend({
        template: _.template($('#account-detail-template').html()),
        render: function(){
          this.$el.html(this.template(this.model.toJSON()));
          return this; // enable chained calls
        },
        initialize: function(){
          this.model.on('destroy', this.remove, this);
          this.render();
        },
        events: {
          'change' : 'change',
          'click .save' : 'save',
          'click .destroy': 'destroy'
        },
        change: function (event) {
            // Apply the change to the model
            var target = event.target;
            var change = {};
            change[target.name] = target.value;
            this.model.set(change);
        },
        save: function(){
          this.model.save(null, {
              success: function(model) {
                app.router.navigate('/', true);
              },
              error: function () {
                alert('Error saving');
              }
            });
        },
        destroy: function(){
          this.model.destroy({
            success: function() {
              app.router.navigate('/', true);              
            },
              error: function () {
                alert('Error deleting');
              }
          });
        }
      });

      // renders the full list of Accounts calling AccountView for each one.
      app.AccountsView = Backbone.View.extend({
        template: _.template($('#accounts-template').html()),
        initialize: function() {
          this.render();
          this.input = this.$('#new-account');
          this.model.on('add', this.render, this);
          this.model.on('reset', this.render, this);
        },
        events: {
          'keypress #new-account': 'createAccountOnEnter'
        },
        createAccountOnEnter: function(e){
          if ( e.which !== 13 || !this.input.val().trim() ) { // ENTER_KEY = 13
            return;
          }
          // Wait for the server response so we have the Id with which to render 
          // the new Account
          this.model.create(this.newAttributes(), {wait: true});
          this.input.val(''); // clean input box
        },
        renderOne: function(account){
          var view = new app.AccountView({model: account});
          this.$('#account-list').append(view.render().el);
        },
        render: function(){
          this.$el.html(this.template());
          this.$('#account-list').html('');
          for (var i = 0, l = this.model.models.length; i < l; i++) {
            this.renderOne(this.model.models[i]);
          }
        },
        newAttributes: function(){
          return {
            Name: this.input.val().trim()
          }
        }
      });

      //Define the Application Router
      app.Router = Backbone.Router.extend({ 
        routes: {
          "": "accounts",
          ":id": "account"
        },          
        accounts: function() {
          var accountsCollection = new app.AccountsCollection();
          accountsCollection.fetch({success: function(){
            $("#content").html(new app.AccountsView({model: accountsCollection}).el);
          }});
        },
        account: function(id) {
          var account = new app.Account({Id: id});
          account.fetch({success: function(){
            $("#content").html(new app.AccountDetailView({model: account}).el);
          }});
        }
      });

      app.router = new app.Router();
      Backbone.history.start();
    }
  </script>

</body>
</html>